name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Monday at 6am UTC to catch breaking changes in repos
    - cron: '0 6 * * 1'

jobs:
  integration-debian:
    name: Full Integration Test - Debian 12
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run full setup in Debian container
        run: |
          # Create a Debian 12 container
          docker run -d --name debian-integration \
            --privileged \
            -v $PWD:/workspace \
            -w /workspace \
            debian:12 \
            sleep infinity
          
          # Wait for container to be ready
          sleep 2
          
          # Install basic requirements including kcov for coverage
          docker exec debian-integration bash -c "
            apt-get update && apt-get install -y sudo curl git procps wget cmake g++ pkg-config libcurl4-openssl-dev libdw-dev libiberty-dev binutils-dev zlib1g-dev
            
            # Install kcov for bash coverage
            cd /tmp
            wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz
            tar xzf master.tar.gz
            cd kcov-master
            mkdir build
            cd build
            cmake ..
            make
            make install
            cd /workspace
          "
          
          # Create test user
          docker exec debian-integration bash -c "
            useradd -m -s /bin/bash testuser
            echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
            chown -R testuser:testuser /workspace
          "
          
          echo "âœ… Container setup complete"
          
          # Run the setup script (with modifications to skip interactive parts)
          docker exec -u testuser debian-integration bash -c "
            export DEBIAN_FRONTEND=noninteractive
            export HOME=/home/testuser
            cd /workspace
            
            # Create a test version of setup.sh that skips p10k configure
            sed 's/p10k configure/echo \"Skipping p10k configure in CI\"/g' setup.sh > setup-test.sh
            chmod +x setup-test.sh
            
            echo '=== Starting setup script with coverage ==='
            mkdir -p /tmp/coverage
            kcov --exclude-pattern=/usr /tmp/coverage ./setup-test.sh 2>&1 | tee setup.log || echo 'Setup completed with warnings'
            
            # Copy coverage data
            sudo cp -r /tmp/coverage /workspace/coverage-debian
          "
          
          echo "âœ… Setup script executed"
          
          # Generate coverage summary
          docker exec debian-integration bash -c "
            if [ -d /workspace/coverage-debian ]; then
              echo '=== Code Coverage Summary ==='
              # Extract coverage percentage from kcov output
              if [ -f /workspace/coverage-debian/setup-test.sh/index.html ]; then
                grep -o 'covered\">[0-9.]*%' /workspace/coverage-debian/setup-test.sh/index.html | head -1 | sed 's/covered\">//' || echo 'Coverage data available'
              fi
            fi
          "
          
          # Verify critical components were installed
          echo "=== Verifying installations ==="
          
          docker exec debian-integration bash -c "
            echo '--- Checking swap ---'
            [ -f /swapfile ] && echo 'âœ… Swap file created' || echo 'âš ï¸  Swap file not created (may require reboot)'
            
            echo '--- Checking Docker ---'
            which docker && echo 'âœ… Docker binary installed' || echo 'âŒ Docker not found'
            
            echo '--- Checking Docker Compose ---'
            docker compose version && echo 'âœ… Docker Compose installed' || echo 'âš ï¸  Docker Compose not found'
            
            echo '--- Checking Zsh ---'
            which zsh && echo 'âœ… Zsh installed' || echo 'âŒ Zsh not found'
            
            echo '--- Checking Oh My Zsh ---'
            [ -d /home/testuser/.oh-my-zsh ] && echo 'âœ… Oh My Zsh installed' || echo 'âŒ Oh My Zsh not found'
            
            echo '--- Checking LazyGit ---'
            which lazygit && echo 'âœ… LazyGit installed' || echo 'âŒ LazyGit not found'
            
            echo '--- Checking Neovim ---'
            which nvim && echo 'âœ… Neovim installed' || echo 'âŒ Neovim not found'
            
            echo '--- Checking bat ---'
            which bat && echo 'âœ… bat installed' || echo 'âŒ bat not found'
            
            echo '--- Checking fzf ---'
            which fzf && echo 'âœ… fzf installed' || echo 'âŒ fzf not found'
            
            echo '--- Checking code-server setup ---'
            [ -d /home/testuser/code-server ] && echo 'âœ… code-server directory created' || echo 'âŒ code-server directory not found'
            [ -f /home/testuser/code-server/docker-compose.yml ] && echo 'âœ… docker-compose.yml exists' || echo 'âŒ docker-compose.yml not found'
            [ -f /home/testuser/code-server/.env ] && echo 'âœ… .env file exists' || echo 'âŒ .env not found'
            [ -f /home/testuser/code-server/PASSWORD.txt ] && echo 'âœ… PASSWORD.txt exists' || echo 'âŒ PASSWORD.txt not found'
            
            echo '--- Checking UFW ---'
            which ufw && echo 'âœ… UFW installed' || echo 'âš ï¸  UFW not found (may not be active in container)'
          "
          
          echo "=== Integration test completed ==="
          
          # Cleanup
          docker stop debian-integration
          docker rm debian-integration

      - name: Upload Debian Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-debian
          path: coverage-debian/
          retention-days: 30

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'coverage-debian/setup-test.sh/index.html';
            
            if (fs.existsSync(path)) {
              const html = fs.readFileSync(path, 'utf8');
              const match = html.match(/covered">([0-9.]+)%/);
              const coverage = match ? match[1] : 'N/A';
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ“Š Debian Test Coverage\n\n**Code Coverage: ${coverage}%**\n\n[View Full Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              });
            }

  integration-fedora:
    name: Full Integration Test - Fedora 42
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run full setup in Fedora container
        run: |
          # Create a Fedora 42 container
          docker run -d --name fedora-integration \
            --privileged \
            -v $PWD:/workspace \
            -w /workspace \
            fedora:42 \
            sleep infinity
          
          # Wait for container to be ready
          sleep 2
          
          # Install basic requirements
          docker exec fedora-integration bash -c "dnf install -y sudo curl git procps-ng"
          
          # Create test user
          docker exec fedora-integration bash -c "
            useradd -m -s /bin/bash testuser
            echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
            chown -R testuser:testuser /workspace
          "
          
          echo "âœ… Container setup complete"
          
          # Run the setup script (with modifications to skip interactive parts)
          docker exec -u testuser fedora-integration bash -c "
            export HOME=/home/testuser
            cd /workspace
            
            # Create a test version of setup.sh that skips p10k configuration
            sed 's/p10k configure/echo \"Skipping p10k configure in CI\"/g' setup.sh > setup-test.sh
            chmod +x setup-test.sh
            
            echo '=== Starting setup script ==='
            ./setup-test.sh 2>&1 | tee setup.log || echo 'Setup completed with warnings'
          "
          
          echo "âœ… Setup script executed"
          
          # Verify critical components were installed
          echo "=== Verifying installations ==="
          
          docker exec fedora-integration bash -c "
            echo '--- Checking swap ---'
            [ -f /swapfile ] && echo 'âœ… Swap file created' || echo 'âš ï¸  Swap file not created (may require reboot)'
            
            echo '--- Checking Docker ---'
            which docker && echo 'âœ… Docker binary installed' || echo 'âŒ Docker not found'
            
            echo '--- Checking Docker Compose ---'
            docker compose version && echo 'âœ… Docker Compose installed' || echo 'âš ï¸  Docker Compose not found'
            
            echo '--- Checking Zsh ---'
            which zsh && echo 'âœ… Zsh installed' || echo 'âŒ Zsh not found'
            
            echo '--- Checking Oh My Zsh ---'
            [ -d /home/testuser/.oh-my-zsh ] && echo 'âœ… Oh My Zsh installed' || echo 'âŒ Oh My Zsh not found'
            
            echo '--- Checking LazyGit ---'
            which lazygit && echo 'âœ… LazyGit installed' || echo 'âŒ LazyGit not found'
            
            echo '--- Checking Neovim ---'
            which nvim && echo 'âœ… Neovim installed' || echo 'âŒ Neovim not found'
            
            echo '--- Checking bat ---'
            which bat && echo 'âœ… bat installed' || echo 'âŒ bat not found'
            
            echo '--- Checking fzf ---'
            which fzf && echo 'âœ… fzf installed' || echo 'âŒ fzf not found'
            
            echo '--- Checking firewalld ---'
            which firewall-cmd && echo 'âœ… firewalld installed' || echo 'âš ï¸  firewalld not found (may not be active in container)'
            
            echo '--- Checking code-server setup ---'
            [ -d /home/testuser/code-server ] && echo 'âœ… code-server directory created' || echo 'âŒ code-server directory not found'
            [ -f /home/testuser/code-server/docker-compose.yml ] && echo 'âœ… docker-compose.yml exists' || echo 'âŒ docker-compose.yml not found'
            [ -f /home/testuser/code-server/.env ] && echo 'âœ… .env file exists' || echo 'âŒ .env not found'
            [ -f /home/testuser/code-server/PASSWORD.txt ] && echo 'âœ… PASSWORD.txt exists' || echo 'âŒ PASSWORD.txt not found'
          "
          
          echo "=== Integration test completed ==="
          
          # Cleanup
          docker stop fedora-integration
          docker rm fedora-integration

  deploy-script-test:
    name: Test Deploy Script
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test deploy script logic
        run: |
          # Test that deploy script has correct structure
          echo "=== Checking deploy.sh structure ==="
          
          grep -q "scp" deploy.sh && echo "âœ… SCP command present" || echo "âŒ SCP missing"
          grep -q "ssh" deploy.sh && echo "âœ… SSH command present" || echo "âŒ SSH missing"
          grep -q "setup.sh" deploy.sh && echo "âœ… References setup.sh" || echo "âŒ Missing setup.sh reference"
          
          echo "âœ… Deploy script structure verified"

  verify-script-test:
    name: Test Verify Script
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test verify script
        run: |
          # Create a mock environment
          mkdir -p ~/code-server
          touch ~/code-server/PASSWORD.txt
          echo "test-password" > ~/code-server/PASSWORD.txt
          
          # Run verify script
          bash verify.sh || echo "Verify script completed with expected warnings"
          
          echo "âœ… Verify script executed successfully"

  coverage-summary:
    name: Coverage Summary
    needs: [integration-debian, integration-fedora]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Download Debian Coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-debian
          path: coverage-debian/
      
      - name: Generate Coverage Summary
        run: |
          echo "# ðŸ“Š Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f coverage-debian/setup-test.sh/index.html ]; then
            DEBIAN_COV=$(grep -o 'covered\">[0-9.]*%' coverage-debian/setup-test.sh/index.html | head -1 | sed 's/covered\">//' || echo "N/A")
            echo "## Debian 12" >> $GITHUB_STEP_SUMMARY
            echo "- **Coverage:** $DEBIAN_COV" >> $GITHUB_STEP_SUMMARY
            echo "- Lines executed during integration test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract line coverage stats
            LINES=$(grep -o 'Lines:[^<]*' coverage-debian/setup-test.sh/index.html | head -1 || echo "Lines: N/A")
            echo "- $LINES" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage data not available for Debian" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Coverage shows which lines of setup.sh were executed during testing*" >> $GITHUB_STEP_SUMMARY
